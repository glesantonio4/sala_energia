<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Registro para obtener tu premio</title>
  <link rel="stylesheet" href="styles.css" />

  <!-- Supabase JS (BASE MUCH) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root {
      --card-bg: #23272f;
      --card-br: 18px;
      --shadow-soft: 0 2px 12px rgba(0, 0, 0, .12);
      --gris-200: #e5e7eb;
      --gris-300: #d1d5db;
      --gris-600: #4b5563;
      --gris-700: #374151;
      --fucsia: #e6007a;
      --turquesa: #00c9b7;
      --error: #ef4444;
      --ok: #10b981;
    }

    body {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      padding: 30px;
      background: #181a20;
      color: #fff;
    }

    .registro-container {
      background: var(--card-bg);
      border-radius: var(--card-br);
      box-shadow: var(--shadow-soft);
      padding: 24px 22px 26px;
      width: 100%;
      max-width: 520px;
      border: 1px solid var(--gris-300);
    }

    .logo-wrap {
      display: flex;
      justify-content: center;
      margin-bottom: 10px;
    }

    .brand-logo {
      width: clamp(120px, 42vw, 220px);
      max-width: 70%;
      height: auto;
      display: block;
      image-rendering: -webkit-optimize-contrast;
      -ms-interpolation-mode: bicubic;
      filter: drop-shadow(0 2px 8px rgba(0, 0, 0, .35));
    }

    h2 {
      text-align: center;
      margin: 8px 0 14px;
      color: var(--fucsia);
      line-height: 1.2;
    }

    p.lead {
      text-align: center;
      margin: 0 0 18px;
      color: #cbd5e1;
    }

    .form-group {
      margin-bottom: 18px;
    }

    .form-group label {
      font-weight: 700;
      display: block;
      margin-bottom: 8px;
      color: #e5e7eb;
    }

    .form-group input {
      width: 100%;
      padding: 12px;
      border-radius: 10px;
      border: 1px solid var(--gris-300);
      font-size: 16px;
      background: #0f1218;
      color: #fff;
      outline: none;
    }

    .form-group input:focus {
      border-color: var(--turquesa);
      box-shadow: 0 0 0 3px rgba(0, 201, 183, .2);
    }

    .hint {
      font-size: .85rem;
      color: #9ca3af;
      margin-top: 6px;
    }

    .error-msg {
      font-size: .85rem;
      color: var(--error);
      margin-top: 6px;
      display: none;
    }

    .is-invalid {
      border-color: var(--error) !important;
      box-shadow: 0 0 0 3px rgba(239, 68, 68, .2) !important;
    }

    .submit-btn {
      background: linear-gradient(90deg, var(--turquesa), var(--fucsia));
      color: #fff;
      font-weight: 800;
      padding: 14px;
      border: 0;
      border-radius: 12px;
      width: 100%;
      cursor: pointer;
      font-size: 18px;
      transition: opacity .2s, transform .02s;
    }

    .submit-btn:active {
      transform: scale(.995);
    }

    .submit-btn[disabled] {
      opacity: .6;
      cursor: not-allowed;
    }

    @media (max-width: 360px) {
      .registro-container {
        padding: 18px 16px 22px;
      }

      h2 {
        font-size: 1.15rem;
      }

      .brand-logo {
        width: clamp(110px, 50vw, 180px);
      }
    }

    /* === MODAL STYLES === */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.85);
      backdrop-filter: blur(4px);
      z-index: 9999;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 1rem;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
    }

    .modal-overlay.active {
      opacity: 1;
      pointer-events: auto;
    }

    .modal-card {
      background: #1f2937;
      border: 1px solid var(--turquesa);
      border-radius: 20px;
      padding: 2rem;
      max-width: 420px;
      width: 100%;
      text-align: center;
      transform: translateY(20px);
      transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      box-shadow: 0 20px 50px rgba(0, 201, 183, 0.15);
    }

    .modal-overlay.active .modal-card {
      transform: translateY(0);
    }

    .modal-icon {
      font-size: 3rem;
      margin-bottom: 1rem;
      display: block;
    }

    .modal-title {
      font-size: 1.5rem;
      font-weight: 800;
      color: #fff;
      margin: 0 0 0.5rem;
    }

    .modal-text {
      color: #d1d5db;
      margin-bottom: 1.5rem;
      font-size: 1.1rem;
      line-height: 1.5;
    }

    .btn-modal {
      background: var(--turquesa);
      color: #0f172a;
      font-weight: 800;
      padding: 12px 24px;
      border-radius: 99px;
      border: none;
      font-size: 1.1rem;
      width: 100%;
      cursor: pointer;
      transition: transform 0.1s;
    }

    .btn-modal:active {
      transform: scale(0.96);
    }
  </style>
</head>

<body>
  <div class="registro-container">
    <div class="logo-wrap">
      <img src="./logo-much.png" alt="MUCH ¬∑ Museo de Ciencia y Tecnolog√≠a" class="brand-logo">
    </div>

    <h2>Reg√≠strate para reclamar tu premio üêÜ</h2>
    <p class="lead">Gracias por visitar el MUCH</p>

    <form id="registroForm" autocomplete="off" novalidate>
      <div class="form-group">
        <label for="nombre">Nombre completo</label>
        <input type="text" id="nombre" name="nombre" required inputmode="text" minlength="6" maxlength="80"
          placeholder="Ej. Celi Glescanni" title="Escribe tu nombre completo (m√≠nimo 2 palabras)." />
        <div class="hint">Usa al menos dos palabras. Se permiten acentos y espacios.</div>
        <div class="error-msg" id="err-nombre"></div>
      </div>

      <div class="form-group">
        <label for="correo">Correo electr√≥nico</label>
        <input type="email" id="correo" name="correo" required inputmode="email" maxlength="120"
          placeholder="tucorreo@dominio.com" autocomplete="email" />
        <div class="hint">Debe ser un correo v√°lido (evita temporales).</div>
        <div class="error-msg" id="err-correo"></div>
      </div>

      <div class="form-group">
        <label for="telefono">N√∫mero de tel√©fono</label>
        <input type="tel" id="telefono" name="telefono" required inputmode="numeric" pattern="[0-9]{10}" maxlength="10"
          placeholder="Agrega 10 d√≠gitos" title="Solo n√∫meros, de 10 d√≠gitos." />
        <div class="hint">Solo 10 d√≠gitos.</div>
        <div class="error-msg" id="err-telefono"></div>
      </div>

      <button type="submit" id="submitBtn" class="submit-btn">Obtener mi Boleto</button>
    </form>
  </div>

  <!-- WELCOME MODAL -->
  <div id="welcomeModal" class="modal-overlay">
    <div class="modal-card">
      <span class="modal-icon">üéâ</span>
      <h3 class="modal-title">¬°Gracias por participar!</h3>
      <p class="modal-text">Para hacer v√°lido el boleto agrega tu <strong>nombre completo</strong>.</p>
      <button id="closeModalBtn" class="btn-modal">Continuar</button>
    </div>
  </div>

  <script>
    // ---------- Supabase Client (BASE MUCH) ----------
    const SUPABASE_URL = 'https://qwgaeorsymfispmtsbut.supabase.co';
    const SUPABASE_ANON_KEY =
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InF3Z2Flb3JzeW1maXNwbXRzYnV0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIzODcyODUsImV4cCI6MjA3Nzk2MzI4NX0.FThZIIpz3daC9u8QaKyRTpxUeW0v4QHs5sHX2s1U1eo';

    let supabaseClient = null;
    if (window.supabase && typeof window.supabase.createClient === 'function') {
      supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
      console.log('[REGISTRO] Supabase client inicializado');
    } else {
      console.error('[REGISTRO] Supabase JS no disponible:', window.supabase);
    }

    const qs = new URLSearchParams(location.search);
    const salaSlug = qs.get('sala') || 'energia';

    // ---------- Validadores ----------
    const reNombre = /^[A-Za-z√Å√â√ç√ì√ö√ú√ë√°√©√≠√≥√∫√º√±]+(?:[ \t]+[A-Za-z√Å√â√ç√ì√ö√ú√ë√°√©√≠√≥√∫√º√±'.-]+){1,}$/;
    const reEmail = /^[^\s@]+@[^\s@]+\.[^\s@]{2,}$/i;
    const rePhone = /^\d{10}$/;
    const disposableDomains = ["10minutemail.com", "guerrillamail.com", "tempmail.com", "yopmail.com", "mailinator.com", "trashmail.com", "sharklasers.com"];
    const $ = (id) => document.getElementById(id);

    function setError(inputEl, errEl, msg) {
      inputEl.classList.add('is-invalid');
      errEl.textContent = msg;
      errEl.style.display = 'block';
    }
    function clearError(inputEl, errEl) {
      inputEl.classList.remove('is-invalid');
      errEl.textContent = '';
      errEl.style.display = 'none';
    }

    function validateNombre(raw) {
      const nombre = raw.trim().replace(/\s+/g, ' ');
      if (nombre.length < 6) return "Es muy corto. Escribe tu nombre completo.";
      if (!reNombre.test(nombre)) return "Escribe al menos nombre y apellido (solo letras y espacios).";
      return null;
    }
    function validateEmail(raw) {
      const email = raw.trim().toLowerCase();
      if (!reEmail.test(email)) return "Correo no v√°lido.";
      const domain = email.split('@')[1] || '';
      if (disposableDomains.includes(domain)) return "Este dominio de correo no es permitido.";
      return null;
    }
    function validatePhone(raw) {
      const tel = raw.trim();
      if (!rePhone.test(tel)) return "El tel√©fono debe tener 10 d√≠gitos.";
      return null;
    }

    // ---------- Guardar en Supabase ----------
    async function guardarEnSupabase(nombre, correo, telefono, prizeData) {
      if (!supabaseClient) {
        console.warn('[REGISTRO] supabaseClient es null');
        return;
      }

      try {
        // 1. Insertar el GANADOR con datos completos
        const folioNew = prizeData.folio || ('MUCH-' + Math.random().toString(36).substring(2, 8).toUpperCase());

        // Calcular vigencia (30 d√≠as por defecto)
        const validUntil = new Date();
        validUntil.setDate(validUntil.getDate() + 30);

        const { data: winnerData, error: winnerError } = await supabaseClient
          .from('Ganadores')
          .insert({
            nombre,
            correo,
            telefono,
            folio: folioNew,
            valido_desde: new Date().toISOString(),
            valido_hasta: validUntil.toISOString(),
            estatus: 'activo',
            tipo_entrada: prizeData.label || 'Premio',
            ubicacion: prizeData.lugar || 'Museo Chiapas'
          })
          .select('id')
          .single();

        if (winnerError) throw new Error('Error guardando Ganador: ' + winnerError.message);

        const winnerID = winnerData.id;
        console.log('[REGISTRO] Ganador guardado. ID:', winnerID);

        // 2. Insertar o VINCLULAR el RECORD DEL QUIZ
        // Intentamos usar el ID de la BD creado por app.js
        let quizDbId = null;
        try { quizDbId = localStorage.getItem('much_quiz_db_id'); } catch (_) { }

        const quizRaw = localStorage.getItem('much_quiz_final_data');
        let qData = {};
        if (quizRaw) qData = JSON.parse(quizRaw);

        if (quizDbId) {
          // A) Si existe ID de quiz, lo ACTUALIZAMOS para vincularlo al participante real
          // Y TAMBIEN aseguramos que el puntaje est√© guardado (por si fall√≥ app.js)
          console.log('[REGISTRO] Vinculando Quiz existente:', quizDbId);

          const updatePayload = {
            participante_id: winnerID,
            estatus: 'finalizado'
          };

          // Si tenemos datos locales, los reforzamos
          if (qData.puntaje_total !== undefined) {
            updatePayload.puntaje_total = qData.puntaje_total;
            updatePayload.num_correctas = qData.num_correctas;
            updatePayload.num_preguntas = qData.num_preguntas;
            updatePayload.finished_at = qData.finished_at || new Date().toISOString();
          }

          const { error: quizUpdateError } = await supabaseClient
            .from('quizzes')
            .update(updatePayload)
            .eq('id', quizDbId);

          if (quizUpdateError) console.error('Error vinculando quiz:', quizUpdateError);
          else console.log('‚úÖ Quiz vinculado al ganador correctamente.');

        } else if (qData.sala_id) {
          // B) Fallback: Si no hay ID de BD (se jug√≥ offline o fall√≥ app.js), INSERTAMOS uno nuevo
          // Esto garantiza que el ganador siempre tenga su registro de quiz
          console.log('[REGISTRO] Insertando Quiz nuevo (Fallback)');
          const quizPayload = {
            sala_id: qData.sala_id,
            participante_id: winnerID,
            started_at: qData.started_at,
            finished_at: qData.finished_at,
            puntaje_total: qData.puntaje_total,
            num_correctas: qData.num_correctas,
            num_preguntas: qData.num_preguntas,
            estatus: 'finalizado'
          };

          const { error: quizError } = await supabaseClient
            .from('quizzes')
            .insert(quizPayload);

          if (quizError) console.error('Error guardando Quiz (Fallback):', quizError.message);
          else console.log('‚úÖ Quiz guardado correctamente linked a ganador (Fallback).');
        }

      } catch (err) {
        console.error('Error general guardarEnSupabase:', err);
      }
    }

    // ---------- Submit ----------
    let submitting = false;

    $('registroForm').addEventListener('submit', async function (e) {
      e.preventDefault();
      if (submitting) return;
      submitting = true;
      $('submitBtn').setAttribute('disabled', 'disabled');

      const nombre = $('nombre').value;
      const correo = $('correo').value;
      const telefono = $('telefono').value;

      let ok = true;
      const nErr = validateNombre(nombre); if (nErr) { ok = false; setError($('nombre'), $('err-nombre'), nErr); } else { clearError($('nombre'), $('err-nombre')); }
      const cErr = validateEmail(correo); if (cErr) { ok = false; setError($('correo'), $('err-correo'), cErr); } else { clearError($('correo'), $('err-correo')); }
      const tErr = validatePhone(telefono); if (tErr) { ok = false; setError($('telefono'), $('err-telefono'), tErr); } else { clearError($('telefono'), $('err-telefono')); }

      if (!ok) {
        submitting = false;
        $('submitBtn').removeAttribute('disabled');
        return;
      }

      // Premio generado por el quiz (much_quiz_prize)
      let prizeData = null;
      try {
        const raw = localStorage.getItem('much_quiz_prize');
        if (raw) prizeData = JSON.parse(raw);
      } catch (_) { }

      // Plan B si no hay nada en localStorage
      if (!prizeData) {
        const folio = 'MUCH-' + Math.random().toString(36).substring(2, 8).toUpperCase();
        prizeData = {
          title: 'MUCH ¬∑ Premio',
          label: 'Entrada al Museo MUCH',
          lugar: 'Museo Chiapas (MUCH)',
          folio: folio,
          date: new Date().toISOString(),
          emoji: 'üéÅ',
          sala: salaSlug
        };
        try { localStorage.setItem('much_quiz_prize', JSON.stringify(prizeData)); } catch (_) { }
      }

      // Guardar en BD
      try {
        await guardarEnSupabase(
          nombre.trim().replace(/\s+/g, ' '),
          correo.trim().toLowerCase(),
          telefono.trim(),
          prizeData
        );
      } catch (err) {
        console.error('Error guardando en Supabase:', err);
      }

      // Par√°metros para boleto.html
      const params = new URLSearchParams({
        nombre: nombre.trim().replace(/\s+/g, ' '),
        correo: correo.trim().toLowerCase(),
        telefono: telefono.trim(),
        premio: prizeData.label || '',
        folio: prizeData.folio || '',
        lugar: prizeData.lugar || '',
        sala: salaSlug
      });

      // Evitar doble canje desde el mismo dispositivo
      try { localStorage.removeItem('much_quiz_prize'); } catch (_) { }

      window.location.href = 'boleto.html?' + params.toString();
    });

    // Validaci√≥n en vivo
    ['nombre', 'correo', 'telefono'].forEach(id => {
      $(id).addEventListener('input', () => {
        const map = {
          nombre: [validateNombre, $('err-nombre')],
          correo: [validateEmail, $('err-correo')],
          telefono: [validatePhone, $('err-telefono')]
        };
        const [fn, errEl] = map[id];
        const msg = fn($(id).value);
        if (msg) setError($(id), errEl, msg); else clearError($(id), errEl);
      });
    });

    // Modal Control
    const modal = document.getElementById('welcomeModal');
    const closeBtn = document.getElementById('closeModalBtn');

    // Auto-show modal
    setTimeout(() => modal.classList.add('active'), 100);

    // Close logic
    closeBtn.addEventListener('click', () => {
      modal.classList.remove('active');
    });
  </script>