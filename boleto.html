<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Boleto Ganador ¬∑ MUCH</title>

  <style>
    :root{
      --ink:#0b1220; --muted:#64748b; --turquesa:#06b6d4; --fucsia:#d946ef;
      --paper:#ffffff; --paper-line:#e5e7eb; --chip-bg:#ecfeff; --chip-ink:#075985;
    }
    *{ box-sizing:border-box; }
    html,body{ height:100%; overflow-x:hidden; }
    img{ max-width:100%; height:auto; }
    body{
      margin:0;
      font-family: system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif;
      color:var(--ink);
      background:
        radial-gradient(1200px 800px at 20% 20%, rgba(255,255,255,.5), transparent 60%),
        linear-gradient(135deg, #0ea5b9, #ec4899, #38bdf8, #f472b6);
      background-size:200% 200%;
      animation:bgmove 24s ease-in-out infinite;
      display:flex; align-items:center; justify-content:center;
      padding:
        max(24px, env(safe-area-inset-top))
        max(24px, env(safe-area-inset-right))
        max(24px, env(safe-area-inset-bottom))
        max(24px, env(safe-area-inset-left));
    }
    @keyframes bgmove{ 0%{background-position:0% 50%} 50%{background-position:100% 50%} 100%{background-position:0% 50%} }

    .ticket-shell{ width:min(920px, 96%); margin-inline:auto; }
    .ticket-card{
      background:var(--paper); border-radius:20px; box-shadow:0 24px 48px rgba(2,6,23,.18);
      border:1px solid rgba(255,255,255,.4); padding:clamp(18px, 3vw, 28px);
    }
    .ticket-paper{
      border:2px dashed var(--paper-line); border-radius:16px;
      padding:clamp(18px, 3vw, 26px); position:relative; background:#fff;
    }

    /* CABECERA: grid 3 columnas (logo - centro - logo) */
    .ticket-head{
      display:grid;
      grid-template-columns: auto 1fr auto;
      grid-template-areas:
        "logoL center logoR";
      align-items:center; gap:12px; margin-bottom:10px;
    }
    .ticket-logo{
      grid-area:auto;
      width:140px; max-width:40vw; border-radius:15px; padding:6px; object-fit:contain;
      background:#fff; border:1px solid #eef2ff; box-shadow:0 6px 16px rgba(6,182,212,.22);
    }
    .logo-left{ grid-area:logoL; }
    .logo-right{ grid-area:logoR; }
    .center{ grid-area:center; min-width:0; }

    .ticket-title{
      font-weight:900; letter-spacing:.3px; color:var(--fucsia);
      font-size:clamp(18px, 2.4vw, 22px); margin:0;
      line-height:1.15; overflow-wrap:anywhere;
    }
    .folio{
      display:inline-flex; align-items:center; gap:8px; background:var(--chip-bg); color:var(--chip-ink);
      font-weight:800; padding:6px 10px; border-radius:999px; border:1px solid #bae6fd;
      margin-top:6px; font-size:.95rem; max-width:100%; white-space:normal; line-height:1.1;
    }

    .rows{ margin-top:10px; border-top:1px solid var(--paper-line); padding-top:10px; }
    .row{ display:flex; gap:12px; align-items:baseline; padding:8px 0; border-bottom:1px dashed #eef2ff; }
    .row:last-child{ border-bottom:0; }
    .label{ min-width:128px; color:var(--muted); font-weight:700; }
    .value{ font-weight:700; overflow-wrap:anywhere; word-break:break-word; line-height:1.25; }

    .note{ margin-top:12px; background:#f8fafc; border:1px dashed #e2e8f0; color:#0f172a; padding:12px 14px; border-radius:12px; font-size:.95rem; }
    .actions{ display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-start; margin-top:16px; }
    .btn{ appearance:none; border:0; cursor:pointer; border-radius:12px; padding:10px 14px; font-weight:800; font-size:.95rem; display:inline-flex; align-items:center; gap:8px; text-decoration:none; }
    .btn-print{ background:var(--turquesa); color:#fff; }
    .btn-print:hover{ filter:brightness(1.05); }
    .btn-link{ background:#fff; color:#0b1220; border:1px solid #e5e7eb; }
    .muted{ color:var(--muted); font-weight:600; margin-top:10px; }

    /* M√ìVIL */
    @media (max-width: 600px){
      body{
        padding:
          max(12px, env(safe-area-inset-top))
          max(12px, env(safe-area-inset-right))
          max(12px, env(safe-area-inset-bottom))
          max(12px, env(safe-area-inset-left));
      }
      .ticket-shell{ width:100%; }
      .ticket-card{ padding:14px; border-radius:16px; box-shadow:0 14px 28px rgba(2,6,23,.16); }
      .ticket-paper{ padding:14px; border-radius:14px; }

      /* cabecera: logos m√°s contenidos y folio pasa debajo del t√≠tulo */
      .ticket-logo{ width:96px; max-width:30vw; }
      .ticket-head{
        grid-template-columns: auto 1fr auto;
        gap:10px;
      }
      .ticket-title{ font-size:clamp(17px, 5vw, 20px); }
      .folio{ display:block; margin-top:6px; }

      .row{ display:grid; grid-template-columns:1fr; gap:4px; padding:10px 0; }
      .label{ min-width:0; font-size:.9rem; }
      .value{ font-size:1rem; }
      .actions .btn{ flex:1 1 100%; justify-content:center; padding:12px; font-size:1rem; }
    }

    /* IMPRESI√ìN */
    @media print{
      html,body{ background:#fff !important; animation:none !important; }
      body{ padding:0 !important; }
      .ticket-shell{ width:100%; padding:0; margin:0; }
      .ticket-card{ box-shadow:none; border:0; padding:0; }
      .ticket-paper{ border-color:#cbd5e1; }
      .actions, .muted{ display:none !important; }
      @page{ size:A4; margin:14mm; }
    }
  </style>
</head>
<body>
  <div class="ticket-shell">
    <div class="ticket-card">
      <div class="ticket-paper">
        <div class="ticket-head">
          <img class="ticket-logo logo-left" src="./logo-agencia.png" alt="Agencia">
          <div class="center">
            <h2 id="tTitle" class="ticket-title">MUCH ¬∑ Premio</h2>
            <div id="tFolio" class="folio">Folio: </div>
          </div>
          <img class="ticket-logo logo-right" src="./logo-much.png" alt="MUCH">
        </div>

        <div class="rows">
          <div class="row"><div class="label">Beneficiario:</div><div id="tNombre" class="value">‚Äî</div></div>
          <div class="row"><div class="label">Acceso:</div><div id="tPremio" class="value">‚Äî</div></div>
          <div class="row"><div class="label">Validez:</div><div id="tFecha" class="value">‚Äî</div></div>
          <div class="row"><div class="label">Ubicaci√≥n:</div><div id="tLugar" class="value">MUCH</div></div>
          <div class="row"><div class="label">Correo:</div><div id="tCorreo" class="value">‚Äî</div></div>
          <div class="row"><div class="label">Tel√©fono:</div><div id="tTel" class="value">‚Äî</div></div>
        </div>

        <div class="note">
          Presenta este boleto en taquilla. Sujeto a disponibilidad y horarios del museo.
        </div>

        <div class="actions">
          <button class="btn btn-print" onclick="window.print()">üñ®Ô∏è Imprimir Boleto</button>
          <a class="btn btn-link" href="index.html">‚Ü©Ô∏è Volver al inicio</a>
        </div>

        <div class="muted">Sugerencia: guarda o imprime este boleto. El folio es √∫nico.</div>
      </div>
    </div>
  </div>

  <script>
  (function(){
    const qs = new URLSearchParams(location.search);

    let prizeData = null;
    try{
      const raw = localStorage.getItem('much_quiz_prize');
      if(raw) prizeData = JSON.parse(raw);
    }catch(_){}

    const nombreQS  = qs.get('nombre')   || '';
    const correoQS  = qs.get('correo')   || '';
    const telQS     = qs.get('telefono') || '';
    const premioQS  = qs.get('premio')   || '';
    const folioQS   = qs.get('folio')    || '';
    const lugarQS   = qs.get('lugar')    || '';

    const hoy = new Date();
    const fin = new Date(hoy); fin.setDate(hoy.getDate() + 7);
    const fmt = new Intl.DateTimeFormat('es-MX', { dateStyle: 'long' });
    const fechaHoy = fmt.format(hoy);
    const fechaFin = fmt.format(fin);

    const nombre = nombreQS || '‚Äî';
    const correo = correoQS || '‚Äî';
    const tel    = telQS    || '‚Äî';
    const premio = (prizeData?.label) || premioQS || 'Entrada general';
    const folio  = (prizeData?.folio) || folioQS  || ('MUCH-' + Math.random().toString(36).substring(2,8).toUpperCase());
    const lugar  = (prizeData?.lugar) || lugarQS  || 'MUCH';
    const title  = (prizeData?.title) || 'MUCH ¬∑ Premio';

    const el = (id)=> document.getElementById(id);
    el('tTitle').textContent  = title;
    el('tFolio').textContent  = 'Folio: ' + folio;
    el('tNombre').textContent = nombre;
    el('tPremio').textContent = premio;
    el('tFecha').textContent  = `Del ${fechaHoy} al ${fechaFin} (v√°lido 7 d√≠as)`;
    el('tLugar').textContent  = lugar;
    el('tCorreo').textContent = correo;
    el('tTel').textContent    = tel;
  })();
  </script>

  <!-- ‚úÖ Nuevo: Supabase para asegurar que el boleto est√© registrado -->
  <script type="module">
    import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';

    const SUPABASE_URL = 'https://qwgaeorsymfispmtsbut.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InF3Z2Flb3JzeW1maXNwbXRzYnV0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIzODcyODUsImV4cCI6MjA3Nzk2MzI4NX0.FThZIIpz3daC9u8QaKyRTpxUeW0v4QHs5sHX2s1U1eo';

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const qs = new URLSearchParams(location.search);

    let prizeData = null;
    try{
      const raw = localStorage.getItem('much_quiz_prize');
      if(raw) prizeData = JSON.parse(raw);
    }catch(_){}

    const nombreRaw  = qs.get('nombre')   || '';
    const correoRaw  = qs.get('correo')   || '';
    const telRaw     = qs.get('telefono') || '';
    const premioRaw  = qs.get('premio')   || '';
    const folioRaw   = qs.get('folio')    || '';

    const nombre = nombreRaw.trim().replace(/\s+/g,' ');
    const correo = correoRaw.trim().toLowerCase();
    const telefono = telRaw.trim();
    const premioLabel = (prizeData?.label) || premioRaw || 'Entrada general';
    const folio  = (prizeData?.folio) || folioRaw  || null;

    function addDays(date, days){
      return new Date(date.getTime() + days*24*60*60*1000);
    }

    async function upsertParticipante(nombre, correo, telefono){
      if (!correo) return null;
      try{
        let { data, error } = await supabase
          .from('participantes')
          .select('id')
          .eq('correo', correo)
          .limit(1);

        if (!error && data && data.length){
          return data[0].id;
        }

        ({ data, error } = await supabase
          .from('participantes')
          .insert({ nombre, correo, telefono })
          .select('id')
          .single());

        if (error){
          console.warn('[boleto] Error insertando participante:', error.message);
          return null;
        }
        return data?.id || null;
      }catch(e){
        console.warn('[boleto] upsertParticipante error:', e?.message || e);
        return null;
      }
    }

    async function getPremioId(premioLabel){
      try{
        let query = supabase.from('premios').select('id, nombre, tipo').limit(1);

        const lower = (premioLabel || '').toLowerCase();
        if (lower.includes('planetario')){
          query = query.eq('tipo','planetario');
        }else if (lower.includes('museo')){
          query = query.eq('tipo','museo');
        }else if (premioLabel){
          query = query.ilike('nombre', premioLabel);
        }

        const { data, error } = await query;
        if (error){
          console.warn('[boleto] Error buscando premio:', error.message);
          return null;
        }
        if (data && data.length) return data[0].id;
        return null;
      }catch(e){
        console.warn('[boleto] getPremioId error:', e?.message || e);
        return null;
      }
    }

    async function ensureBoleto({ participante_id, folio, premioLabel }){
      if (!participante_id || !folio) return;
      try{
        // ¬øYa existe este folio?
        let { data, error } = await supabase
          .from('boletos')
          .select('id')
          .eq('folio', folio)
          .limit(1);

        if (!error && data && data.length){
          return; // ya est√°
        }

        const hoy = new Date();
        const desde = hoy.toISOString().slice(0,10);
        const hasta = addDays(hoy, 7).toISOString().slice(0,10);

        const premio_id = await getPremioId(premioLabel);

        const payload = {
          participante_id,
          folio,
          valido_desde: desde,
          valido_hasta: hasta
        };

        if (premio_id) payload.premio_id = premio_id;

        ({ error } = await supabase.from('boletos').insert(payload));
        if (error){
          console.warn('[boleto] Error creando boleto:', error.message);
        }
      }catch(e){
        console.warn('[boleto] ensureBoleto error:', e?.message || e);
      }
    }

    (async () => {
      try{
        if (!folio) {
          console.warn('[boleto] No hay folio, no se registra en BD.');
          return;
        }
        const participante_id = await upsertParticipante(nombre, correo, telefono);
        await ensureBoleto({ participante_id, folio, premioLabel });
      }catch(e){
        console.warn('[boleto] Error general conectando con BD:', e?.message || e);
      }
    })();
  </script>
</body>
</html>
